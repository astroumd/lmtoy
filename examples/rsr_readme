#! /usr/bin/env bash
#
#    creates the README.html file for a standard RSR "TAP"
#

#            required:   2 arguments
obsnum=$1
   src=$2

echo "<B>Few notes on <A HREF=http://lmtgtm.org/telescope/instrumentation/instruments/rsr/>RSR</A> and the information you see here:</B>"
echo "<OL>"
echo "<LI> 4 chassis represent the two beams and two polarizations; they are normally averaged to increase S/N"
echo "<LI> 6 boards, which if taken in the order 0,2,1,3,5,4 are the bands sorted by increasing frequency (color coded in our plots)"
echo "<LI> each board has 256 channels. For a lag space plot, see lags.png, the waterfall plot is in rsr.wf.pdf"
echo "<LI> a small number of typically 30sec integrations are in each obsnum"
echo "<LI> often multiple obsnums need to be stacked for a full observation. this can cover several days"
echo "<LI> the final spectrum is a single band merged spectrum covering the full 73-111 GHz range, averaged in time and chassis"
echo "<LI> Band edges are at 73.0, 79.7, 86.0, 92.1, 98.6, 104.9, 111.0 GHz, with a small overlap between bands."
echo "<LI> Channel width is 31.25 MHz or about 100 km/s at the 3mm (W) band"
echo "<LI> There is no source doppler tracking, though observations are on a common (helio?)centric frame"
echo "</OL>"
echo ""
echo "Here is a summary of the data products of obsnum=$obsnum"
echo "resulting from running the RSR pipeline."
echo ""

echo "<OL>"

echo "<LI>"

if [ -e lags.png ]; then
    echo "The badlags, as identified by large RMS in the "
    echo " channel vs. ACF_sigma for the number of time samples (lag consistency)."
    echo " Boards are color coded by their board (notice band order is 0,2,1,3,5,4)"
    echo "<br><IMG SRC=lags.png>"
    echo "<br> <A HREF=rsr3.log>seek_bad_channels.py -> rsr3.log</A>"
    echo "Manually edit..."
    echo "             <-> <B>rsr.$obsnum.badlags</B>"    
    echo "<hr>"
else
    echo " In this combined obsnum version we don't re-compute the baglags"
fi


# echo "rsr4.log:  seek_bad_channels.py (Author: P.Schloerb)"
# echo "              -> <A HREF=lags.png>lags.png</A>  (notice band order 0,2,1,3,5,4 is different from bank order)"
# echo "                 but the same colors are used for the same band"



echo "<LI>"
echo "rsr_driver spectrum:"
echo "<br>"
echo "A Waterfall Spectrum: the spectrum for each band, chassis and time sample, color codes by their band:"
echo "<br>"
echo "  The original one with minimal flagging <A HREF=rsr.wf0.pdf>rsr.wf0.pdf</A>"
echo "  and the one that has the latest flags applied:"
echo "              -> <A HREF=rsr.wf.pdf>rsr.wf.pdf</A> "
echo "  in case the pipeline applied badlags and/or has been re-executed."

echo "<br> <A HREF=rsr1.log>rsr_driver.py -> rsr1.log</A>"
echo "<br>            <-> <B>rsr.$obsnum.rfile</B>"
echo "<br>            -> ${src}_rsr_spectrum.txt"


echo "<LI>"
echo "rsr_sum spectrum:"
echo "<br>rsr2.log:  rsr_sum.py (Author: M.Yun) with optional blanking (edit rsr.blanking for now)"
echo "              -> rsr.$obsnum.blanking.sum.txt"
echo "             <-> <B>rsr.$obsnum.blanking</B>"

echo "<br> <A HREF=rsr2.log>rsr_sum.py -> rsr2.log</A>"



cat $LMTOY/examples/template.svg.html | sed s/template.svg/rsr.spectra.svg/g > rsr.spectra.svg.html
rsync $LMTOY/etc/resources .

echo "<LI>"
echo " Here is the final two spectra combined in a single plot:"
echo "(or try <A HREF=rsr.spectra.svg.html>rsr.spectra.svg</A>)"
echo "<br><IMG SRC=rsr.spectra.png>"

echo "<br>and a zoomed version in the last band:"
echo "<br><IMG SRC=rsr.spectra_co.png>"
echo "If there is a significant difference between the two, there is some subtle difference in how the scripts work".


adirs=$(ls -d *.admit) || adir=""

echo "<LI>"
echo "A few admit results are also available, but no information on the VLSR was available, so the LineID is likely bogus:"
echo "  <OL>"
for adir in $adirs; do
    echo "<LI> <A HREF=$adir>$adir</A>"
done
echo "  </OL>"
echo "<hr>"
echo "Updated: `date`"

